<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Juno Eclipse: The Infinite Nexus Sabotage</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* --- Animated Space Background --- */
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Inter:wght@400;700;900&display=swap');

        :root {
            --color-primary: #8b5cf6; /* Violet */
            --color-secondary: #000000;
            --color-background: #1f2937; /* Dark Slate - Game box background */
            --color-card-bg: #f3f4f6;
            --color-card-border: #d1d5db;
            --color-text: #ffffff;
            --color-success: #34d399; /* Emerald Green */
            --color-warning: #fcd34d;
            --color-error: #ef4444; /* Red */
            --color-temporal: #f472b6; /* Pink for Stability */
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #000000;
            color: var(--color-text);
            overflow-x: hidden;
            min-height: 100vh;
        }

        /* Starfield Animation */
        .starfield {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(200% 100% at 50% 100%, #171717, #000000);
            z-index: -1;
            overflow: hidden;
        }

        .star {
            position: absolute;
            background: white;
            border-radius: 50%;
            opacity: 0;
            animation: twinkle linear infinite;
        }

        /* Function to generate random star properties for a nice spread */
        @keyframes twinkle {
            0% { opacity: 0.1; transform: scale(0.5); }
            50% { opacity: 0.8; transform: scale(1); }
            100% { opacity: 0.1; transform: scale(0.5); }
        }

        /* Generate 100 stars with unique properties via JS (see below) or simplified with generic classes */
        .star-small { width: 1px; height: 1px; animation-duration: 2s; animation-delay: 0s; }
        .star-medium { width: 2px; height: 2px; animation-duration: 3s; animation-delay: 1s; }
        .star-large { width: 3px; height: 3px; animation-duration: 4s; animation-delay: 2s; }

        /* --- Custom CSS for The Juno Eclipse Game (Re-included for self-contained functionality) --- */
        #game-outer-wrapper {
            width: 100%;
            padding: 20px 0;
            position: relative; 
            z-index: 10;
        }

        #game-container-wp {
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            background-color: rgba(31, 41, 55, 0.95); /* Dark Slate with slight transparency */
            color: var(--color-text);
            border-radius: 12px;
            box-shadow: 0 0 40px rgba(139, 92, 246, 0.2); /* Soft violet glow */
            border: 1px solid #374151;
        }

        #game-container-wp h1 {
            font-family: 'Orbitron', sans-serif;
            text-align: center;
            color: var(--color-primary);
            margin-bottom: 20px;
            font-size: 2.2rem;
            font-weight: 900;
            text-shadow: 0 0 10px rgba(139, 92, 246, 0.8);
        }

        .status-item {
            padding: 2px 0;
            transition: background-color 0.1s;
        }
        @keyframes flash-green {
            0%, 100% { background-color: transparent; }
            50% { background-color: rgba(52, 211, 153, 0.4); }
        }
        @keyframes flash-red {
            0%, 100% { background-color: transparent; }
            50% { background-color: rgba(239, 68, 68, 0.4); }
        }
        .status-item.flashing-green { animation: flash-green 0.5s ease-out 2; }
        .status-item.flashing-red { animation: flash-red 0.5s ease-out 2; }
        .status-block { background-color: #374151; padding: 12px; border-radius: 8px; box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.3); border: 1px solid #4b5563; }
        .black-card { background-color: var(--color-secondary); color: var(--color-text); padding: 20px; border-radius: 8px; min-height: 120px; display: flex; flex-direction: column; justify-content: space-between; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.6); }
        .white-card { background-color: var(--color-card-bg); color: var(--color-secondary); padding: 12px; border-radius: 8px; border: 1px solid var(--color-card-border); flex: 1 1 calc(33.333% - 10px); min-width: 150px; cursor: pointer; transition: all 0.2s; display: flex; flex-direction: column; justify-content: space-between; font-size: 0.9rem; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2); user-select: none; }
        .absurdity-rating { font-weight: bold; font-size: 0.75rem; padding: 2px 0; }
        .white-card.selected { border: 3px solid var(--color-primary); background-color: #e0f2fe; box-shadow: 0 0 15px var(--color-primary); }
        .card-theme-tag { font-size: 0.7rem; color: #6b7280; text-align: right; margin-top: 8px; border-top: 1px dashed #e5e7eb; padding-top: 5px; }
        #story-history { max-height: 200px; overflow-y: auto; padding: 10px; border: 1px solid #4b5563; border-radius: 8px; background-color: #2c3545; }
        #story-history::-webkit-scrollbar { width: 8px; }
        #story-history::-webkit-scrollbar-thumb { background: #525252; border-radius: 10px; }
        #story-history::-webkit-scrollbar-track { background: #1f2937; }
        .history-result { padding: 5px; border-left: 4px solid var(--color-primary); background-color: #374151; }
        .msg-info { color: #9ca3af; font-style: italic; }
        .msg-success { color: var(--color-success); font-weight: bold; }
        .msg-warning { color: var(--color-warning); font-weight: bold; }
        .msg-error { color: var(--color-error); font-weight: bold; }
        .msg-synergy { color: #5eead4; }

        @media (max-width: 600px) {
            .white-card { flex: 1 1 calc(50% - 10px); }
        }
    </style>
</head>
<body>
    
    <!-- Animated Starfield Background -->
    <div class="starfield" id="starfield"></div>

    <div id="game-outer-wrapper">
        <div id="game-container-wp" class="mx-auto">
            
            <header class="text-center pb-8 border-b border-violet-700 mb-6">
                <h1 class="text-3xl md:text-5xl">JUNO ECLIPSE</h1>
                <p class="text-xl md:text-2xl text-violet-400 font-bold">The Infinite Nexus Sabotage</p>
            </header>
            
            <!-- Game Description and Instructions -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-8 mb-10">
                
                <div class="md:col-span-2 space-y-4">
                    <h2 class="text-2xl font-bold text-violet-300">The Mission Briefing</h2>
                    <p class="text-gray-300">You are **Juno Eclipse**, the galaxy's most chaotic and effective temporal infiltrator. The **Nexus AI** is attempting to stabilize the multiverse by enforcing canon and logic. Your job is simple: **Inject enough high-tier absurdity into pivotal spacetime events to fracture its control, all while maintaining a credible front.**</p>
                    <p class="text-gray-300">This is a high-stakes, **choose-your-own-chaos** card game. Choose the right level of absurdity and theme to maximize your **Rebel Standing** without destroying your ship (**Hull Integrity**) or dissolving reality (**Temporal Stability**).</p>
                    
                    <h2 class="text-2xl font-bold text-violet-300 pt-4">Instructions:</h2>
                    <ul class="list-disc list-inside text-gray-300 space-y-2 pl-4">
                        <li>**Objective:** Survive as many chapters as possible, achieving the highest **Rebel Standing** score.</li>
                        <li>**The Crisis (Black Card):** A new scenario appears, usually tied to a specific **Theme** (SW, ST, ME, etc.).</li>
                        <li>**The Response (White Cards):** Select one or more cards from your hand to complete the Black Card text.</li>
                        <li>**Strategy (Absurdity):** Each White Card has a hidden **Absurdity Score (1-5)**, now displayed on the card.
                            <ul class="list-disc list-inside ml-6 text-sm text-gray-400">
                                <li>**Low Absurdity (1-2):** Safe, but often too 'canon,' leading to failure and damage.</li>
                                <li>**High Absurdity (4-5):** High risk, but if successful, huge **Standing** gains. High risk of catastrophic failure.</li>
                            </ul>
                        </li>
                        <li>**Synergy:** Matching your card's theme to the Black Card's theme grants a **Standing Bonus**.</li>
                        <li>**Game Over:** You lose if your **Hull Integrity** or **Temporal Stability** hits 0%, or if **Rebel Standing** falls below 10.</li>
                    </ul>
                </div>

                <div class="md:col-span-1 flex justify-center items-start pt-4">
                    <figure class="flex flex-col items-center">
                        <!-- Caption (Text) placed first, as requested -->
                        <figcaption class="text-center text-sm italic mb-4 text-violet-400">Juno Eclipse prepares a new temporal sabotage</figcaption>
                        <!-- Image placed below the caption -->
                        
                    </figure>
                </div>
            </div>
            
            <hr class="border-violet-700 my-6">

            <!-- --- GAME START --- -->
            
            <div class="text-center mb-4 flex justify-center space-x-4">
                <button id="mode-solo" class="selected-mode bg-violet-600 hover:bg-violet-700 text-white font-bold py-2 px-4 rounded-full transition-all duration-200">Solo Mode</button>
                <button id="mode-vs-computer" class="bg-gray-700 hover:bg-violet-700 text-white font-bold py-2 px-4 rounded-full transition-all duration-200">Vs. Computer Mode</button>
            </div>

            <!-- Status Bar -->
            <div id="status-bar" class="flex flex-col md:flex-row justify-between gap-3 mb-6">
                <div class="status-block flex-1">
                    <h3 class="font-bold text-lg text-violet-300">Juno Eclipse (You)</h3>
                    <div class="status-item text-sm" id="chapter-item">Chapter: <span id="chapter-count" class="font-mono text-lg text-yellow-300">0</span></div>
                    <div class="status-item text-sm" id="health-item">Hull Integrity: <span id="human-health-stat" class="font-mono text-lg">100%</span></div>
                    <div class="status-item text-sm" id="standing-item">Rebel Standing: <span id="human-standing-stat" class="font-mono text-lg">60</span></div>
                    <div class="status-item text-sm" id="stability-item">Stability: <span id="human-stability-stat" class="font-mono text-lg">100%</span></div>
                </div>
                <div class="status-block hidden flex-1" id="computer-stats">
                    <h3 class="font-bold text-lg text-red-400">The Nexus AI (Opponent)</h3>
                    <div class="status-item text-sm" id="comp-health-item">Hull Integrity: <span id="computer-health-stat" class="font-mono text-lg">100%</span></div>
                    <div class="status-item text-sm" id="comp-standing-item">Control Standing: <span id="computer-standing-stat" class="font-mono text-lg">60</span></div>
                    <div class="status-item text-sm" id="comp-stability-item">Stability: <span id="computer-stability-stat" class="font-mono text-lg">100%</span></div>
                </div>
            </div>
            
            <!-- Story History -->
            <div id="story-history" class="mb-6 text-sm">
                <p class="history-text-center msg-info">Initializing temporal relay...</p>
            </div>

            <!-- Card Area -->
            <div id="card-area">
                <div id="black-card-display" class="black-card mb-4">
                    <span id="black-card-text" class="text-center font-bold text-lg">Select a mode and start the campaign.</span>
                </div>
                
                <div id="submission-area" class="hidden mb-4">
                    <h2 class="hand-title text-yellow-300 mb-2 font-bold">Winning Submission: <span id="winning-player"></span></h2>
                    <div id="human-submission" class="flex flex-wrap gap-2"></div>
                    <h2 class="hand-title text-yellow-300 mt-4 mb-2 font-bold hidden" id="losing-submission-title">Losing Submission: <span id="losing-player"></span></h2>
                    <div id="computer-submission" class="flex flex-wrap gap-2"></div>
                </div>

                <h2 id="hand-title" class="hand-title text-violet-400 font-bold text-xl mb-3">Your Hand (<span id="hand-count">0</span> Cards)</h2>
                <div id="hand-area" class="flex flex-wrap justify-center gap-3 mb-4"></div>
                
                <button id="play-card-btn" class="play-button bg-violet-600 hover:bg-violet-700 text-white w-full py-3 mb-4 rounded-lg shadow-xl font-extrabold transition-all duration-200" disabled>
                    Play Chosen Card(s)
                </button>
            </div>
            
            <!-- Action Buttons -->
            <div class="action-buttons flex justify-between gap-3 mt-6">
                <button id="start-game-btn" class="choice-button bg-green-600 hover:bg-green-700 text-white flex-1 py-3 rounded-lg shadow-md font-bold transition-all duration-200">
                    Start New Campaign
                </button>
                <button id="reset-game-btn" class="choice-button reset-button bg-red-600 hover:bg-red-700 text-white flex-1 py-3 rounded-lg shadow-md font-bold transition-all duration-200" disabled>
                    Restart Campaign
                </button>
            </div>

            <!-- --- END GAME --- -->
            
        </div>
    </div>
    
    <!-- JavaScript Logic (Includes Game Logic and Starfield Initialization) -->
    <script>
        (function() {
            
            // --- Starfield Initialization ---
            const starfieldEl = document.getElementById('starfield');
            const NUM_STARS = 150;
            for (let i = 0; i < NUM_STARS; i++) {
                const star = document.createElement('div');
                star.classList.add('star');
                const size = Math.random() < 0.8 ? 'star-small' : (Math.random() < 0.5 ? 'star-medium' : 'star-large');
                star.classList.add(size);
                star.style.top = `${Math.random() * 100}vh`;
                star.style.left = `${Math.random() * 100}vw`;
                star.style.animationDelay = `${Math.random() * 5}s`; 
                star.style.animationDuration = `${2 + Math.random() * 3}s`;
                starfieldEl.appendChild(star);
            }

            
            // --- Configuration (Same as previous file) ---
            const DYNAMIC_COLORS = {
                temporal: '#f472b6', 
                error: '#ef4444', 
                warning: '#fcd34d',
                success: '#34d399',
                absurdityLow: '#10b981', 
                absurdityMid: '#f59e0b', 
                absurdityHigh: '#ef4444' 
            };
            const THEMES = ['SW', 'ST', 'ME', 'SG', 'WHO', 'FIREFLY', 'ALIEN', 'SC', 'LOVECRAFT', 'RANDOM', 'CANON'];
            
            // --- Combinatorial Card Generation Arrays (Trillions in potential combinations) ---
            const ADJECTIVES = ["A tiny", "A weeping", "A sentient", "The final", "An anti-gravity", "A laser-guided", "A holographic", "A malfunctioning", "A highly concentrated", "The crushing", "A rogue", "A porcelain", "An emotionally supportive", "A Volus-sized", "A Krill-based", "An easily confused", "A sentient", "A radioactive", "A perfectly formed", "The terrifying", "A glitter-covered", "A fully functional", "A perpetually bored", "A secretly ambitious", "A suspiciously damp", "An awkward", "The unspeakable", "A sentient", "A rogue", "A single, misplaced", "The horrifying truth of", "A morally ambiguous", "A deeply unsettling", "A hyper-intelligent", "A surprisingly rude", "An entire crate of", "A tiny pair of", "A caffeinated", "A heavily encrypted", "The existential dread of", "An overly dramatic", "A mysteriously damp", "A freshly laundered", "A genetically modified", "An inexplicable, powerful", "A time-displaced", "A morally bankrupt", "A dangerously flammable", "A subtly racist", "An adorable, yet deadly", "A technologically stunted", "A dangerously unstable", "A musically gifted", "A perpetually confused", "A shockingly clean", "A surprisingly sticky", "An ancient, forgotten", "A recently upgraded", "A deeply philosophical", "A suspiciously crunchy", "A non-Euclidean", "The unsettling scent of", "A perpetually surprised", "A slightly melted", "A meticulously calibrated", "A poorly translated", "A vaguely cylindrical", "A politically motivated", "A spontaneously generated", "An emotionally crippled", "A heavily insured", "A digitally preserved", "A physically incapable", "A deceptively simple", "A violently purple", "An economically unsound", "A technologically advanced", "A remarkably bland", "A psychologically damaging", "A cosmically indifferent", "An absurdly expensive", "A criminally underrated", "A universally despised", "A subtly humming", "A surprisingly comfortable", "A geometrically impossible", "A socially inept", "A highly suspicious", "A strangely familiar", "A deceptively bouncy", "An unnecessarily large", "A perpetually glistening", "A disturbingly quiet", "A brightly colored", "An unexpectedly potent", "A strategically placed", "A rhythmically pulsing", "A theoretically sound", "A tragically misplaced"];
            
            const NOUNS = ["Sarlacc Pit", "Tribble", "Gonky Droid", "Jar Jar Binks' sock", "Transporter Chief's coffee cup", "Klingon opera score", "Vorlon Ambassador's wig", "Sonic Screwdriver", "TARDIS key", "Reaper heart", "Volus credit chip", "Mandalorian helmet", "Xenomorph plushie", "Zerg larva", "Stargate power conduit", "Goa'uld snakehead", "Shiny piece of aluminum foil", "Wookiee hairball", "Borg drone's favorite snack", "Jaffa warrior's tear", "Reaver corpse", "Elder Sign", "Mister Potato Head", "Crate of redundant red shirts", "Garrus's calibration schedule", "Sentient pair of pants", "Sentient knitted hat", "Last remaining slice of pizza", "Giant foam finger", "Rubber chicken with a pulley in the middle", "Holodeck safety protocol", "Primary buffer panel", "Deck scrubber", "Fez", "Bow tie", "Bad Wolf graffiti", "Bacta tank drainage plug", "Thermal detonator", "Unidentified green goo", "A stack of ancient data rods", "A particularly noisy modem", "A rogue AI's mood ring", "A microscopic black hole", "A highly aggressive chihuahua", "A three-legged space badger", "A container of emergency glitter", "A universal remote control", "A malfunctioning replicator", "A broken pocket watch", "A very confused Tribble", "A single, powerful sneeze", "A misplaced infinity stone", "A pair of reading glasses", "A worn out VHS tape", "A bucket of spare parts", "A forgotten sandwich", "A deeply philosophical Roomba", "A sentient sock puppet", "A genetically engineered squirrel", "A perfectly ripe banana", "A small, quiet kitten", "A massive ball of twine", "A holographic llama", "A tiny spaceship blueprint", "A cosmic rubber duck", "A mysterious crystal skull", "A jar of pickled onions", "A perfectly circular pebble", "A digital ghost", "A highly polished spoon", "A velvet painting of Elvis", "A map to nowhere", "A rusty can opener", "A singing fish toy", "A portable black hole generator", "A pair of mismatched gloves", "A jar of space jam", "A self-aware rubber band", "A miniature Death Star replica", "A very loud harmonica", "A mysterious box of donuts", "A forgotten lucky charm", "A handful of cosmic dust", "A self-sealing body bag", "A slightly toxic cupcake", "A perpetually spinning top", "A tiny, aggressive ferret", "A highly durable napkin", "A suspiciously clean spork", "A digitally enhanced echo", "A time-traveling goldfish", "A ceremonial battle-spatula", "A perpetually echoing whisper", "A discarded piece of popcorn", "A perfectly normal rock"];

            const VERBS = ["debating", "flossing", "calibrating", "singing", "disassembling", "negotiating", "interrogating", "replicating", "erasing", "wrestling", "romancing", "attempting to fix", "explaining the plot of", "baking a cake shaped like", "performing interpretive dance for", "wearing a tiny hat while", "shouting obscenities at", "rearranging the contents of", "sincerely apologizing to", "demanding a refund for", "ignoring the advice of", "threatening with a lecture on", "writing a passive-aggressive note about", "secretly admiring", "trying to parallel park with", "getting surprisingly emotional about", "blaming the entire crisis on", "teaching basic calculus to", "forcing everyone to listen to", "engaging in a rap battle with", "performing surgery on", "hiding inside", "arguing with", "carefully cataloging", "enthusiastically greeting", "sincerely regretting", "unnecessarily explaining", "aggressively staring at", "gently caressing", "confidently mispronouncing", "frantically searching for", "relentlessly mocking", "inadvertently activating", "professionally reviewing", "violently shaking", "mysteriously transforming into", "publicly weeping over", "silently judging", "attempting to romance", "inappropriately comparing", "suddenly adopting", "solemnly swearing allegiance to", "dramatically unveiling", "secretly taking pictures of", "overwhelming with kindness", "cynically commenting on", "bravely ignoring", "haphazardly repairing", "meticulously dusting", "unintentionally setting fire to", "enthusiastically destroying", "reluctantly accepting", "politely declining", "accidentally eating", "systematically dismantling", "quietly weeping near", "loudly complaining about", "strategically placing", "magically conjuring", "confusing with poetry", "calmly demanding", "brutally critiquing", "passionately defending", "aggressively cuddling", "desperately attempting to hide", "subtly undermining", "forcefully injecting into", "playfully swatting at", "relentlessly cheering for", "unintentionally insulting", "solemnly burying", "gleefully reanimating", "digitally enhancing", "emotionally supporting", "violently disagreeing with", "awkwardly complimenting", "cautiously approaching", "sarcastically praising", "firmly rejecting", "clumsily knocking over", "carefully balancing", "pointlessly measuring", "uncontrollably giggling at", "patiently waiting for", "dangerously licking", "morally compromising"];
            
            const CONTEXTS = ["the entire USS Enterprise-D crew.", "a tiny, decorative teapot.", "the fourth dimension's tax laws.", "a 1980s aerobics instruction video.", "a highly secured box of paperclips.", "Shepard's collection of fish.", "the Citadel Council's worst fears.", "the Borg Queen's dating profile.", "a time-displaced traffic cone.", "a convention of angry Ewoks.", "a rogue Gonk Droid with existential dread.", "the Emperor's new clothes.", "the collected works of William Shatner.", "a deeply philosophical Roomba.", "a highly caffeinated T'ealc.", "the complete history of bad movie sequels.", "a rogue singularity in a coffee pot.", "a perfectly normal office plant.", "the Reapers' primary weakness: glitter.", "the secret recipe for Bantha Blue Milk.", "a Volus aggressively selling insurance.", "the concept of free will and responsibility.", "a stack of overdue library books.", "a highly unstable plasma rifle.", "a rogue asteroid that looks like a potato.", "the secret to eternal youth (it's napping).", "a highly secured box of paperclips.", "a surprisingly clean sock.", "a bucket of extremely confusing Legos.", "a convention of angry Ewoks.", "a highly suspicious garden gnome.", "the horrifying implications of a two-way mirror.", "a sentient puddle of water.", "the universal symbol for 'do not touch'.", "a tiny black hole disguised as a button.", "the concept of causality itself.", "a perpetually running clock.", "the collected thoughts of a space slug.", "a discarded pair of socks.", "a highly sensitive mood ring.", "a jar of artisanal pickles.", "the existential horror of infinite parallel universes.", "a pile of highly compressed nothing.", "the lost episode of Firefly.", "a single, perfect tear.", "the bureaucratic process for timeline repair.", "a highly decorative bath bomb.", "the terrifying sound of silence.", "a perpetually falling feather.", "the political campaign of a sentient nebula.", "a box of disappointment and regret.", "the last remaining drop of oil.", "a highly specialized toothbrush.", "the profound mystery of missing socks.", "a rogue hologram of Captain Kirk.", "the gravitational pull of destiny.", "a bucket of unanswerable questions.", "a single grain of sand.", "a highly sensitive time machine's antenna.", "the concept of 'maybe'.", "a surprisingly effective placebo.", "the rules for multi-level marketing in space.", "a stack of laminated 'I told you so' cards.", "a miniature golf course.", "the complete lyrics to Rick Astley's 'Never Gonna Give Up'.", "a rogue asteroid that looks like a potato.", "the crushing weight of existence itself.", "a self-aware lint roller.", "the universal laws of bad parking.", "a dangerously wobbly chair.", "a container of purified sarcasm.", "the collective subconscious of all accountants.", "a deeply upsetting childhood memory.", "the exact point where art becomes trash.", "a highly aggressive rubber duck.", "the mysterious origin of the ellipsis.", "a tiny, holographic dinosaur.", "the existential threat of Mondays.", "a stack of rejected fan fiction.", "a bowl of cold, damp noodles.", "the principle of least effort.", "a highly contested piece of fruit.", "the philosophical debate over toast.", "a spontaneously generated black hole.", "a perpetually regenerating scratch card.", "the sound of one hand clapping, but louder.", "a tiny, majestic pony.", "the universal sign for 'I need coffee'.", "a misplaced sense of moral superiority.", "a can of highly explosive beans.", "the horrifying reality of reality television.", "a bucket of warm, flat soda.", "the true meaning of 'fartlek'.", "a surprisingly comfortable rock.", "the rules of the intergalactic thumb war championship.", "a highly illegal laser pointer."];

            const CAH_DATA = {
                blackCards: [
                    { text: "Juno, your hyperspace jump ripped you through the veil, depositing you in the middle of a **Klingon** ritual where the prize was [BLANK].", blanks: 1, theme: 'ST' }, 
                    { text: "The only way to close the Stargate before the **Goa'uld** invasion is to use [BLANK] as a makeshift power source.", blanks: 1, theme: 'SG' }, 
                    { text: "We need to fix the **Enterprise-D's** holodeck malfunction, which has resulted in a crisis involving [BLANK].", blanks: 1, theme: 'ST' }, 
                    { text: "Darth Vader's emotional breakdown was triggered by the sight of [BLANK].", blanks: 1, theme: 'SW' },
                    { text: "The **Doctor**'s primary concern in this crisis is the proper application of [BLANK].", blanks: 1, theme: 'WHO' },
                    { text: "The **Borg** Cube's shield frequency can only be modulated by shouting [BLANK] at maximum volume.", blanks: 1, theme: 'ST' },
                    { text: "The **Citadel Council** determined the solution to the **Reapers** was simply [BLANK].", blanks: 1, theme: 'ME' },
                    { text: "The Ancient database revealed that the secret to ascending was actually [BLANK].", blanks: 1, theme: 'SG' },
                    { text: "The political campaign to elect the next supreme intelligence of the **Omni-verse** centered entirely on [BLANK].", blanks: 1, theme: 'WHO' },
                    { text: "A **Xenomorph** queen was found performing a cabaret act involving [BLANK].", blanks: 1, theme: 'ALIEN' },
                    { text: "The worst thing about the **Zerg** swarm isn't the acid, it's [BLANK].", blanks: 1, theme: 'SC' },
                    { text: "The **TARDIS** has disguised itself as [BLANK] and is now stuck in the **Corellian** Sector.", blanks: 1, theme: 'WHO' },
                    { text: "The *true* purpose of the Death Star was to house [BLANK].", blanks: 1, theme: 'SW' },
                    { text: "The **Predator** broke its code of honor for a chance at [BLANK].", blanks: 1, theme: 'ALIEN' },
                    { text: "Juno realized the gravity drive malfunction was caused by [BLANK] on the control panel.", blanks: 1, theme: 'SW' },
                    { text: "Juno, the only way to appease the **Elder Gods** is to sacrifice [BLANK] while simultaneously singing a ballad about [BLANK].", blanks: 2, theme: 'LOVECRAFT' },
                    { text: "To gain passage through **Reaver** territory, Serenity's captain insisted on gifting them [BLANK] and distracting them with [BLANK].", blanks: 2, theme: 'FIREFLY' },
                    { text: "The **Borg**'s assimilation process now requires the drone to first experience the profound disappointment of [BLANK] followed by the crushing reality of [BLANK].", blanks: 2, theme: 'ST' },
                ],
                HAND_SIZE: 7, 
            };

            // --- Game State and Initialization ---
            const INITIAL_STATE = {
                history: [],
                humanStanding: 60,
                humanHealth: 100,
                humanStability: 100, 
                maxStanding: 60,
                humanHand: [],
                computerStanding: 60,
                computerHealth: 100,
                computerStability: 100, 
                gameMode: 'solo', 
                currentChapter: 0,
                isGameOver: false,
                blackCard: null,
                selectedCards: [], 
                usedBlackCardTexts: []
            };

            let gameState = { ...INITIAL_STATE }; 

            // --- DOM Element Refs ---
            const statusItems = {
                'human-health-stat': 'health-item', 
                'human-standing-stat': 'standing-item', 
                'human-stability-stat': 'stability-item',
                'computer-health-stat': 'comp-health-item',
                'computer-standing-stat': 'comp-standing-item',
                'computer-stability-stat': 'comp-stability-item'
            };

            const storyHistoryEl = document.getElementById('story-history');
            const blackCardDisplayEl = document.getElementById('black-card-display');
            const blackCardTextEl = document.getElementById('black-card-text');
            const handAreaEl = document.getElementById('hand-area');
            const playCardBtn = document.getElementById('play-card-btn');
            const resetButtonEl = document.getElementById('reset-game-btn');
            const startGameButtonEl = document.getElementById('start-game-btn');
            const chapterCountEl = document.getElementById('chapter-count');
            const submissionAreaEl = document.getElementById('submission-area');
            const humanSubmissionEl = document.getElementById('human-submission');
            const computerSubmissionEl = document.getElementById('computer-submission');
            const losingSubmissionTitleEl = document.getElementById('losing-submission-title');
            const winningPlayerEl = document.getElementById('winning-player');
            const losingPlayerEl = document.getElementById('losing-player');
            const humanStandingStatEl = document.getElementById('human-standing-stat');
            const humanHealthStatEl = document.getElementById('human-health-stat');
            const humanStabilityStatEl = document.getElementById('human-stability-stat');
            const handCountEl = document.getElementById('hand-count');
            const computerStatsEl = document.getElementById('computer-stats');
            const computerStandingStatEl = document.getElementById('computer-standing-stat');
            const computerHealthStatEl = document.getElementById('computer-health-stat');
            const computerStabilityStatEl = document.getElementById('computer-stability-stat');
            const modeSoloBtn = document.getElementById('mode-solo');
            const modeVsComputerBtn = document.getElementById('mode-vs-computer');

            let isTurnProcessing = false;


            // --- Helper Functions ---
            const getRandom = (arr) => arr[Math.floor(Math.random() * arr.length)];
            const capValue = (value) => Math.min(100, Math.max(0, value));

            function getAbsurdityColor(absurdity) {
                if (absurdity <= 2) return DYNAMIC_COLORS.absurdityLow;
                if (absurdity === 3) return DYNAMIC_COLORS.absurdityMid;
                return DYNAMIC_COLORS.absurdityHigh;
            }
            
            function flashStat(elementId, delta) {
                const el = document.getElementById(statusItems[elementId]);
                if (!el) return;
                
                const className = delta > 0 ? 'flashing-green' : 'flashing-red';
                
                el.classList.add(className);

                setTimeout(() => {
                    el.classList.remove(className);
                }, 1000); 
            }


            function generateWhiteCard() {
                const adjective = getRandom(ADJECTIVES);
                const noun = getRandom(NOUNS);
                const verb = getRandom(VERBS);
                const context = getRandom(CONTEXTS);

                const text = `${adjective} ${noun}, ${verb} ${context}.`;
                
                const absurdity = Math.floor(Math.random() * 5) + 1; 
                const theme = getRandom(THEMES);

                return {
                    text: text,
                    absurdity: absurdity,
                    theme: theme
                };
            }

            function toggleGameControls(disabled) {
                modeSoloBtn.disabled = gameState.currentChapter > 0;
                modeVsComputerBtn.disabled = gameState.currentChapter > 0;
                
                startGameButtonEl.disabled = false;
                resetButtonEl.disabled = gameState.currentChapter === 0;
                
                const required = gameState.blackCard?.blanks || 1;
                playCardBtn.disabled = disabled || gameState.selectedCards.length < required;
            }

            function initializeGame() {
                const currentMode = modeVsComputerBtn.classList.contains('selected-mode') ? 'vs-computer' : 'solo';
                
                gameState = { ...INITIAL_STATE, gameMode: currentMode }; 
                gameState.currentChapter = 0; 
                gameState.maxStanding = INITIAL_STATE.humanStanding; 
                
                submissionAreaEl.classList.add('hidden'); 
                humanSubmissionEl.innerHTML = '';
                computerSubmissionEl.innerHTML = '';
                losingSubmissionTitleEl.classList.add('hidden'); 
                handAreaEl.innerHTML = '';
                
                gameState.blackCard = null; 
                renderBlackCard(); 
                
                startGameButtonEl.style.display = 'block';
                playCardBtn.style.display = 'block';
                
                isTurnProcessing = false;
                gameState.isGameOver = false; 

                storyHistoryEl.innerHTML = `<p class="history-text-center msg-info">Welcome, Captain Juno Eclipse. Current Mode: **${currentMode === 'solo' ? 'Solo' : 'Vs. Computer'}**. Combinatorial card potential: **>100 Million**.</p>`;

                updateStats();
                toggleGameControls(false); 
            }

            function startNewGame() {
                if (isTurnProcessing || gameState.currentChapter > 0) return;

                const selectedMode = modeVsComputerBtn.classList.contains('selected-mode') ? 'vs-computer' : 'solo';

                gameState = { 
                    ...INITIAL_STATE, 
                    gameMode: selectedMode, 
                    usedBlackCardTexts: [],
                    maxStanding: INITIAL_STATE.humanStanding
                };
                
                isTurnProcessing = false;
                submissionAreaEl.classList.add('hidden');
                
                const introText = gameState.gameMode === 'vs-computer' 
                    ? "Campaign initiated against **The Nexus AI**. Defeat its logic core!"
                    : "Solo Campaign initiated. The fate of the multiverse rests on your chaotic genius.";
                
                gameState.history = [{ role: "model", text: introText }];
                
                updateStats(); 
                
                drawHand(gameState.humanHand);
                if (gameState.gameMode === 'vs-computer') {
                    gameState.computerHand = []; 
                    drawHand(gameState.computerHand);
                }

                drawBlackCard();
                gameState.selectedCards = [];
                renderGame();
                toggleGameControls(false); 
                startGameButtonEl.style.display = 'none';
            }

            function drawHand(hand) {
                while (hand.length < CAH_DATA.HAND_SIZE) {
                    const newCard = generateWhiteCard();
                    hand.push(newCard);
                }
            }

            function drawBlackCard() {
                gameState.currentChapter++;
                
                let availableCards = CAH_DATA.blackCards.filter(card => !gameState.usedBlackCardTexts.includes(card.text));
                
                if (availableCards.length === 0) {
                    gameState.usedBlackCardTexts = [];
                    availableCards = CAH_DATA.blackCards; 
                    gameState.history.push({role: "result", text: `<p class="msg-info">Mission file reset. The campaign continues!</p>`});
                }

                gameState.blackCard = getRandom(availableCards); 
                gameState.blackCard.blanks = gameState.blackCard.blanks || 1;
                gameState.usedBlackCardTexts.push(gameState.blackCard.text);
                
                gameState.history.push({
                    role: "model",
                    blackCard: gameState.blackCard,
                    text: `**CHAPTER ${gameState.currentChapter}**: A new crisis rips open the multiverse, requiring a **${gameState.blackCard.theme || 'CANON'}** response.`
                });
            }

            function selectCard(card) {
                if (gameState.isGameOver || !gameState.blackCard || isTurnProcessing) return;
                const required = gameState.blackCard.blanks || 1;
                
                if (!gameState.humanHand.some(c => c.text === card.text)) return; 

                const isCurrentlySelected = gameState.selectedCards.some(c => c.text === card.text);

                if (isCurrentlySelected) {
                    gameState.selectedCards = gameState.selectedCards.filter(c => c.text !== card.text);
                } else {
                    if (gameState.selectedCards.length < required) {
                        gameState.selectedCards.push(card);
                    } else if (required === 1) {
                        gameState.selectedCards = [card];
                    } else {
                        gameState.selectedCards.shift();
                        gameState.selectedCards.push(card);
                    }
                }

                playCardBtn.disabled = (gameState.selectedCards.length < required);
                renderStrategyHand();
            }

            function computerPlayCard() {
                const required = gameState.blackCard.blanks || 1;
                const hand = gameState.computerHand;
                let selections = [];
                let availableCards = [...hand];
                const blackCardTheme = gameState.blackCard.theme;
                
                let targetAbsurdity;

                if (gameState.computerStability <= 30) {
                    targetAbsurdity = 1.5; 
                } else if (gameState.computerStanding <= 40) {
                    targetAbsurdity = 4.5; 
                } else {
                    targetAbsurdity = 3.0; 
                }

                for (let i = 0; i < required; i++) {
                    if (availableCards.length === 0) break; 
                    
                    let candidateCards = [...availableCards];

                    candidateCards.sort((a, b) => {
                        const aSynergy = a.theme === blackCardTheme ? 1 : 0;
                        const bSynergy = b.theme === blackCardTheme ? 1 : 0;
                        
                        if (aSynergy !== bSynergy) {
                            return bSynergy - aSynergy;
                        }
                        
                        const aDiff = Math.abs(a.absurdity - targetAbsurdity);
                        const bDiff = Math.abs(b.absurdity - targetAbsurdity);
                        return aDiff - bDiff;
                    });
                    
                    const preferredCard = candidateCards[0];
                    if (preferredCard) {
                        selections.push(preferredCard);
                        availableCards = availableCards.filter(c => c !== preferredCard);
                    }
                }
                
                return selections;
            }

            function calculateTurnOutcome(cardsPlayed) {
                const required = gameState.blackCard.blanks || 1;

                if (cardsPlayed.length < required) {
                    return { finalAbsurdity: 0, standing: 0, health: 0, stability: 0, loreViolation: "Insufficient cards played. Minimum impact.", resultMessage: "ABORTED TURN.", resultClass: 'msg-error', synergyMatchCount: 0, cards: cardsPlayed };
                }

                const blackCardTheme = gameState.blackCard.theme;

                const totalAbsurdity = cardsPlayed.reduce((sum, card) => sum + card.absurdity, 0);
                const finalAbsurdity = totalAbsurdity / required;
                
                const synergyMatchCount = cardsPlayed.filter(card => card.theme === blackCardTheme).length;
                const synergyBonus = synergyMatchCount * 5;

                let standingDelta = 0;
                let healthDelta = 0;
                let stabilityDelta = 0;
                let loreViolation = "";
                let resultMessage = "";
                let resultClass = "";

                // --- Outcome Logic based on Absurdity ---
                if (finalAbsurdity >= 4.0) {
                    stabilityDelta = -15; 
                    if (Math.random() < 0.6) {
                        standingDelta = 30; 
                        healthDelta = 0;
                        loreViolation = "The combined narrative force shattered the enemy's logic core, but the fabric of reality groaned.";
                        resultMessage = `CRITICAL SUCCESS! +30 Standing! (Base -15 Stability)`;
                        resultClass = 'msg-success';
                    } else {
                        standingDelta = -10;
                        healthDelta = -20; 
                        stabilityDelta = -40;
                        loreViolation = "The absurdity was too much; a timeline singularity formed and collapsed.";
                        resultMessage = `CATASTROPHIC PARADOX! Major Health and Stability Loss!`;
                        resultClass = 'msg-error';
                    }
                } else if (finalAbsurdity >= 2.5) {
                    standingDelta = 15;
                    healthDelta = -5;
                    stabilityDelta = 5;
                    loreViolation = "An acceptable, mid-level violation. Chaos contained but costly.";
                    resultMessage = `PARTIAL SUCCESS. +15 Standing, +5 Stability.`;
                    resultClass = 'msg-warning';
                } else {
                    standingDelta = -5;
                    healthDelta = -25;
                    stabilityDelta = 10;
                    loreViolation = "Your answer was far too canon-compliant and failed to disrupt the enemy timeline.";
                    resultMessage = `FAILURE. Painfully boring and easily accounted for. -25% Hull.`;
                    resultClass = 'msg-error';
                }
                
                // Feature 3: Difficulty Scaling (Multiplier increases by 15% every 5 chapters)
                const difficultyMultiplier = 1 + Math.floor((gameState.currentChapter -1) / 5) * 0.15; 
                
                const finalStandingDelta = Math.round((standingDelta + synergyBonus) * difficultyMultiplier);
                const finalHealthDelta = Math.round(healthDelta * difficultyMultiplier);
                const finalStabilityDelta = Math.round(stabilityDelta * difficultyMultiplier);

                return {
                    finalAbsurdity: finalAbsurdity,
                    standing: finalStandingDelta,
                    health: finalHealthDelta,
                    stability: finalStabilityDelta,
                    loreViolation: loreViolation,
                    resultMessage: resultMessage,
                    resultClass: resultClass,
                    synergyMatchCount: synergyMatchCount,
                    cards: cardsPlayed
                };
            }

            function playTurn() {
                if (isTurnProcessing || gameState.isGameOver) return;

                const required = gameState.blackCard.blanks || 1;
                if (gameState.selectedCards.length < required) {
                    return;
                }
                
                isTurnProcessing = true;
                playCardBtn.disabled = true; 

                try {
                    const humanCards = gameState.selectedCards;
                    let computerCards = []; 
                    
                    let winnerOutcome;
                    let winningSubmission;
                    let losingSubmission = null;
                    
                    const LOSER_HEALTH_PENALTY = -15;
                    const LOSER_STABILITY_PENALTY = -5;
                    
                    let humanHealthChange = 0;
                    let humanStabilityChange = 0;
                    let humanStandingChange = 0;
                    
                    let compHealthChange = 0;
                    let compStabilityChange = 0;
                    let compStandingChange = 0;


                    if (gameState.gameMode === 'solo') {
                        winnerOutcome = calculateTurnOutcome(humanCards);
                        
                        humanStandingChange = winnerOutcome.standing;
                        humanHealthChange = winnerOutcome.health;
                        humanStabilityChange = winnerOutcome.stability;
                        
                        winningSubmission = { cards: humanCards, player: 'Juno' };

                    } else { // Vs. Computer Mode Logic
                        const humanOutcome = calculateTurnOutcome(humanCards);
                        computerCards = computerPlayCard(); 
                        const computerOutcome = calculateTurnOutcome(computerCards);
                        
                        const isHumanWinner = humanOutcome.finalAbsurdity >= computerOutcome.finalAbsurdity;
                        
                        let winner, loser, winnerOutcomeFinal;

                        if (isHumanWinner) {
                            winner = 'Juno';
                            loser = 'Nexus AI';
                            winnerOutcomeFinal = humanOutcome;
                            winningSubmission = { cards: humanCards, player: winner };
                            losingSubmission = { cards: computerCards, player: loser };
                        } else {
                            winner = 'Nexus AI';
                            loser = 'Juno';
                            winnerOutcomeFinal = computerOutcome;
                            winningSubmission = { cards: computerCards, player: winner };
                            losingSubmission = { cards: humanCards, player: loser };
                        }
                        
                        winnerOutcome = winnerOutcomeFinal; 

                        // Apply winner's effects
                        if (winner === 'Juno') {
                            humanStandingChange = winnerOutcomeFinal.standing;
                            humanHealthChange = winnerOutcomeFinal.health;
                            humanStabilityChange = winnerOutcomeFinal.stability;
                        } else {
                            compStandingChange = winnerOutcomeFinal.standing;
                            compHealthChange = winnerOutcomeFinal.health;
                            compStabilityChange = winnerOutcomeFinal.stability;
                        }
                        
                        // Apply loser's penalties
                        if (loser === 'Juno') {
                            humanHealthChange += LOSER_HEALTH_PENALTY;
                            humanStabilityChange += LOSER_STABILITY_PENALTY;
                        } else {
                            compHealthChange += LOSER_HEALTH_PENALTY;
                            compStabilityChange += LOSER_STABILITY_PENALTY;
                        }
                    }
                    
                    // Apply all changes to game state
                    gameState.humanStanding = capValue(gameState.humanStanding + humanStandingChange);
                    gameState.humanHealth = capValue(gameState.humanHealth + humanHealthChange);
                    gameState.humanStability = capValue(gameState.humanStability + humanStabilityChange);
                    gameState.maxStanding = Math.max(gameState.maxStanding, gameState.humanStanding); 

                    if (gameState.gameMode === 'vs-computer') {
                        gameState.computerStanding = capValue(gameState.computerStanding + compStandingChange);
                        gameState.computerHealth = capValue(gameState.computerHealth + compHealthChange);
                        gameState.computerStability = capValue(gameState.computerStability + compStabilityChange);
                    }

                    // --- Flash Stats (Feature 4) ---
                    flashStat('human-health-stat', humanHealthChange);
                    flashStat('human-standing-stat', humanStandingChange);
                    flashStat('human-stability-stat', humanStabilityChange);
                    if (gameState.gameMode === 'vs-computer') {
                        flashStat('computer-health-stat', compHealthChange);
                        flashStat('computer-standing-stat', compStandingChange);
                        flashStat('computer-stability-stat', compStabilityChange);
                    }

                    // --- History Generation ---
                    let completedText = gameState.blackCard.text;
                    let blankIndex = 0;
                    completedText = completedText.replace(/\[BLANK\]/g, (match) => {
                        const card = winningSubmission.cards[blankIndex];
                        blankIndex++;
                        return `<span class="text-red">**${card ? card.text : 'ERROR'}**</span>`;
                    });
                    
                    const difficultyMultiplier = 1 + Math.floor((gameState.currentChapter -1) / 5) * 0.15;
                    let synergyMsg = winnerOutcome.synergyMatchCount > 0 
                        ? `<span class="msg-synergy">(${winnerOutcome.synergyMatchCount}x Lore Synergy: +${winnerOutcome.synergyMatchCount * 5 * difficultyMultiplier} Standing)</span>` 
                        : '';

                    let standingText, healthText, stabilityText, historyMessage;

                    if (losingSubmission) { // Vs. Computer History Message
                        standingText = `Winner (${winningSubmission.player}): ${humanStandingChange > 0 || compStandingChange > 0 ? '+' : ''}${humanStandingChange || compStandingChange} Standing.`;
                        healthText = `Loser (${losingSubmission.player}): ${LOSER_HEALTH_PENALTY}% Hull.`;
                        stabilityText = `Winner (${winningSubmission.player}): ${winnerOutcome.stability > 0 ? '+' : ''}${winnerOutcome.stability} Stability. (Loser: ${LOSER_STABILITY_PENALTY} Stability)`;

                        historyMessage = 
                            `<p class="msg-info">The winning outcome, submitted by <strong>${winningSubmission.player}</strong>: ${completedText}</p>
                            <p>Avg. Absurdity: ${winnerOutcome.finalAbsurdity.toFixed(1)}/5. ${synergyMsg} Multiverse Impact: ${winnerOutcome.loreViolation}</p>
                            <p>${standingText} | ${healthText} | ${stabilityText} | Multiplier: x${difficultyMultiplier.toFixed(2)}</p>
                            <p class="${winnerOutcome.resultClass}">${winnerOutcome.resultMessage}</p>`;
                    } else { // Solo Mode History Message
                        standingText = `Standing: ${humanStandingChange > 0 ? '+' : ''}${humanStandingChange}`;
                        healthText = `Hull: ${humanHealthChange > 0 ? '+' : ''}${humanHealthChange}`;
                        stabilityText = `Stability: ${humanStabilityChange > 0 ? '+' : ''}${humanStabilityChange}`;

                        historyMessage = 
                            `<p class="msg-info">The resulting scenario: ${completedText}</p>
                            <p>Avg. Absurdity: ${winnerOutcome.finalAbsurdity.toFixed(1)}/5. ${synergyMsg} Multiverse Impact: ${winnerOutcome.loreViolation}</p>
                            <p>${standingText} | ${healthText} | ${stabilityText} | Multiplier: x${difficultyMultiplier.toFixed(2)}</p>
                            <p class="${winnerOutcome.resultClass}">${winnerOutcome.resultMessage}</p>`;
                    }

                    gameState.history.push({ role: "result", text: historyMessage });

                    renderSubmission(winningSubmission.cards, humanSubmissionEl); 
                    winningPlayerEl.textContent = winningSubmission.player;
                    
                    if (losingSubmission) {
                        renderSubmission(losingSubmission.cards, computerSubmissionEl);
                        losingPlayerEl.textContent = losingSubmission.player;
                        losingSubmissionTitleEl.classList.remove('hidden');
                    } else {
                        computerSubmissionEl.innerHTML = '';
                        losingSubmissionTitleEl.classList.add('hidden');
                    }

                    submissionAreaEl.classList.remove('hidden');
                    handAreaEl.innerHTML = ''; 
                    
                    renderHistory();
                    updateStats();

                    // --- Next Turn Setup after Delay ---
                    setTimeout(() => {
                        submissionAreaEl.classList.add('hidden');
                        humanSubmissionEl.innerHTML = '';
                        computerSubmissionEl.innerHTML = '';
                        
                        gameState.humanHand = gameState.humanHand.filter(c => !humanCards.some(pc => pc.text === c.text));
                        
                        if (gameState.gameMode === 'vs-computer') {
                            gameState.computerHand = gameState.computerHand.filter(c => !computerCards.some(pc => pc.text === c.text));
                        }

                        if (checkEndGame()) {
                            isTurnProcessing = false;
                            toggleGameControls(false); 
                            return;
                        }

                        drawHand(gameState.humanHand);
                        if (gameState.gameMode === 'vs-computer') { drawHand(gameState.computerHand); }
                        drawBlackCard(); 
                        
                        gameState.selectedCards = [];
                        
                        isTurnProcessing = false; 
                        
                        renderGame(); 
                        
                        playCardBtn.disabled = (gameState.selectedCards.length < (gameState.blackCard.blanks || 1)); 
                        
                        toggleGameControls(false); 
                    }, 3500); 
                } catch (error) {
                    console.error("Critical error during turn processing:", error);
                    storyHistoryEl.innerHTML += `<p class="history-result text-sm msg-error">A CRITICAL SCRIPT ERROR OCCURRED! Please reset the campaign. Check console for details.</p>`;
                    renderHistory();
                    isTurnProcessing = false; 
                    toggleGameControls(false); 
                }
            }

            function checkEndGame() {
                if (gameState.humanHealth <= 0 || gameState.humanStability <= 0 || gameState.humanStanding <= 10) {
                    let message = "GAME OVER";
                    if (gameState.humanHealth <= 0) message = "Juno Eclipse, Hull Integrity compromised! The ship failed to survive the paradox. **GAME OVER**.";
                    else if (gameState.humanStanding <= 10) message = "Juno's chaotic methods caused a catastrophic loss of credibility. You are grounded by a joint tribunal. **GAME OVER**.";
                    else if (gameState.humanStability <= 0) message = "Temporal Stability Reached 0%! The paradox ripple erased your ship and crew from history. **TIMELINE PARADOX**.";
                    endGame(message, false); 
                    return true;
                } 
                
                if (gameState.gameMode === 'vs-computer' && (gameState.computerHealth <= 0 || gameState.computerStability <= 0 || gameState.computerStanding <= 10)) {
                    let message = `Victory! The Nexus AI's core was destroyed by its own illogical submissions. **Juno Eclipse Triumphs!**`;
                    endGame(message, true); 
                    return true;
                }
                return false;
            }

            function endGame(message, isWin) {
                gameState.isGameOver = true;
                handAreaEl.innerHTML = '';
                
                const condition = message.split(':')[0];

                const summaryHTML = `
                    <div class="mt-4 p-4 rounded-lg text-left" style="background-color: #111827; border: 1px solid ${isWin ? DYNAMIC_COLORS.success : DYNAMIC_COLORS.error};">
                        <h4 class="font-bold text-lg mb-2" style="color:${isWin ? DYNAMIC_COLORS.success : DYNAMIC_COLORS.error};">Campaign Summary</h4>
                        <p><strong>Total Chapters Survived:</strong> ${gameState.currentChapter}</p>
                        <p><strong>Max Rebel Standing Achieved:</strong> ${gameState.maxStanding}/100</p>
                        <p><strong>Final Hull Integrity:</strong> ${gameState.humanHealth}%</p>
                        <p><strong>Game Over Condition:</strong> ${condition}</p>
                    </div>
                `;

                blackCardTextEl.innerHTML = `<div class="end-game-message" style="color:${isWin ? DYNAMIC_COLORS.success : DYNAMIC_COLORS.error};">${message}</div>${summaryHTML}`;
                blackCardDisplayEl.style.backgroundColor = '#2c3545';
                blackCardDisplayEl.style.color = DYNAMIC_COLORS.text; 
                blackCardDisplayEl.classList.remove('black-card');
                blackCardDisplayEl.classList.add('game-over-display');

                playCardBtn.style.display = 'none';
                
                startGameButtonEl.style.display = 'block';
                toggleGameControls(false); 
                resetButtonEl.disabled = false;
            }

            // --- Rendering and UI Updates ---

            function renderSubmission(cards, targetEl) {
                targetEl.innerHTML = '';
                cards.forEach(card => {
                    const cardEl = document.createElement('div');
                    cardEl.classList.add('white-card', 'submission-card');

                    const textDiv = document.createElement('div');
                    textDiv.textContent = card.text;
                    
                    const absurdityEl = document.createElement('div');
                    absurdityEl.classList.add('absurdity-rating');
                    absurdityEl.textContent = `Absurdity: ${card.absurdity}/5`;
                    absurdityEl.style.color = getAbsurdityColor(card.absurdity);
                    
                    const tagDiv = document.createElement('div');
                    tagDiv.classList.add('card-theme-tag');
                    tagDiv.textContent = `Theme: ${card.theme || 'CANON'}`;
                    
                    cardEl.appendChild(textDiv);
                    cardEl.appendChild(absurdityEl);
                    cardEl.appendChild(tagDiv);
                    targetEl.appendChild(cardEl);
                });
            }

            function renderGame() {
                renderHistory();
                updateStats();
                renderBlackCard();
                renderStrategyHand();
            }

            function renderHistory() {
                storyHistoryEl.innerHTML = '';
                gameState.history.forEach(item => {
                    const p = document.createElement('p');
                    p.classList.add('text-sm');
                    
                    if (item.role === 'model') {
                        p.classList.add('history-model', 'text-white', 'font-bold');
                        p.innerHTML = `<strong>${item.text}</strong>`;
                    } else if (item.role === 'result') {
                        p.classList.add('history-result');
                        p.innerHTML = item.text;
                    }
                    storyHistoryEl.appendChild(p);
                });
                storyHistoryEl.scrollTop = storyHistoryEl.scrollHeight;
            }

            function updateStats() {
                chapterCountEl.textContent = gameState.currentChapter;
                
                // Human Stats
                humanStandingStatEl.textContent = `${gameState.humanStanding}/100`;
                humanHealthStatEl.textContent = `${gameState.humanHealth}%`;
                humanStabilityStatEl.textContent = `${gameState.humanStability}%`;
                
                humanStabilityStatEl.style.color = gameState.humanStability > 75 ? DYNAMIC_COLORS.temporal : gameState.humanStability < 30 ? DYNAMIC_COLORS.error : DYNAMIC_COLORS.warning;
                humanStandingStatEl.style.color = gameState.humanStanding > 75 ? DYNAMIC_COLORS.success : gameState.humanStanding < 30 ? DYNAMIC_COLORS.error : DYNAMIC_COLORS.warning;
                humanHealthStatEl.style.color = gameState.humanHealth > 70 ? DYNAMIC_COLORS.success : gameState.humanHealth < 30 ? DYNAMIC_COLORS.error : DYNAMIC_COLORS.warning;
                handCountEl.textContent = gameState.humanHand.length; 

                // Computer Stats visibility control 
                if (gameState.gameMode === 'vs-computer') {
                    computerStatsEl.classList.remove('hidden');
                    computerStandingStatEl.textContent = `${gameState.computerStanding}/100`;
                    computerHealthStatEl.textContent = `${gameState.computerHealth}%`;
                    computerStabilityStatEl.textContent = `${gameState.computerStability}%`;

                    computerStabilityStatEl.style.color = gameState.computerStability > 75 ? DYNAMIC_COLORS.temporal : gameState.computerStability < 30 ? DYNAMIC_COLORS.error : DYNAMIC_COLORS.warning;
                    computerStandingStatEl.style.color = gameState.computerStanding > 75 ? DYNAMIC_COLORS.success : gameState.computerStanding < 30 ? DYNAMIC_COLORS.error : DYNAMIC_COLORS.warning;
                    computerHealthStatEl.style.color = gameState.computerHealth > 70 ? DYNAMIC_COLORS.success : gameState.computerHealth < 30 ? DYNAMIC_COLORS.error : DYNAMIC_COLORS.warning;
                } else {
                    computerStatsEl.classList.add('hidden');
                }
            }

            function renderBlackCard() {
                if (gameState.blackCard) {
                    blackCardDisplayEl.style.backgroundColor = '#000000'; 
                    blackCardDisplayEl.style.color = '#ffffff';
                    blackCardDisplayEl.classList.remove('game-over-display');
                    blackCardDisplayEl.classList.add('black-card');

                    let text = gameState.blackCard.text.replace(/\[BLANK\]/g, '<span class="text-red">BLANK</span>');
                    
                    const required = gameState.blackCard.blanks || 1;
                    const info = `<div class="required-cards-info pt-2 border-t border-gray-700 mt-2 text-sm text-gray-400">Theme: ${gameState.blackCard.theme || 'CANON'} | Requires: ${required} card${required > 1 ? 's' : ''}</div>`;
                    
                    playCardBtn.textContent = `Play Chosen Card${required > 1 ? 's' : ''}`; 

                    blackCardTextEl.innerHTML = `<div class="text-center font-bold text-xl">${text}</div> ${info}`;
                } else {
                    blackCardTextEl.textContent = "Select a mode and start the campaign.";
                }
            }

            function renderStrategyHand() {
                if (submissionAreaEl.classList.contains('hidden') && !isTurnProcessing) { 
                    handAreaEl.innerHTML = '';
                    if (gameState.isGameOver) return;

                    gameState.humanHand.forEach(card => {
                        const cardEl = document.createElement('div');
                        cardEl.classList.add('white-card');
                        cardEl.title = `Absurdity: ${card.absurdity}/5 | Theme: ${card.theme}`;

                        const textDiv = document.createElement('div');
                        textDiv.textContent = card.text;
                        
                        const absurdityEl = document.createElement('div');
                        absurdityEl.classList.add('absurdity-rating');
                        absurdityEl.textContent = `Absurdity: ${card.absurdity}/5`;
                        absurdityEl.style.color = getAbsurdityColor(card.absurdity);
                        
                        const tagDiv = document.createElement('div');
                        tagDiv.classList.add('card-theme-tag');
                        tagDiv.textContent = `Theme: ${card.theme || 'CANON'}`;
                        
                        cardEl.appendChild(textDiv);
                        cardEl.appendChild(absurdityEl);
                        cardEl.appendChild(tagDiv);
                        
                        const isSelected = gameState.selectedCards.some(c => c.text === card.text);

                        if (isSelected) {
                            cardEl.classList.add('selected');
                        } else {
                            cardEl.classList.remove('selected');
                        }

                        cardEl.addEventListener('click', () => {
                            selectCard(card);
                        });
                        handAreaEl.appendChild(cardEl);
                    });
                }
            }

            function setModeUI(mode) {
                if (gameState.currentChapter > 0 && !gameState.isGameOver) return; 

                modeSoloBtn.classList.remove('selected-mode', 'bg-violet-600', 'bg-gray-700');
                modeVsComputerBtn.classList.remove('selected-mode', 'bg-violet-600', 'bg-gray-700');
                
                if (mode === 'solo') {
                    modeSoloBtn.classList.add('selected-mode', 'bg-violet-600');
                    modeVsComputerBtn.classList.add('bg-gray-700');
                } else {
                    modeVsComputerBtn.classList.add('selected-mode', 'bg-violet-600');
                    modeSoloBtn.classList.add('bg-gray-700');
                }

                initializeGame(); 
            }

            // --- Event Listeners and Initialization ---
            document.addEventListener('DOMContentLoaded', function() {
                modeSoloBtn.addEventListener('click', () => setModeUI('solo'));
                modeVsComputerBtn.addEventListener('click', () => setModeUI('vs-computer'));
                
                resetButtonEl.addEventListener('click', initializeGame); 
                startGameButtonEl.addEventListener('click', startNewGame);
                
                playCardBtn.addEventListener('click', playTurn);

                setModeUI('solo'); // Initialize default mode
                initializeGame();
            });
        })();
    </script>
</body>
</html>
